- name: Bootstrap for running a basic service (via Docker)
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  vars:
    docker_arch: "{{ 'arm64' if ansible_architecture in ['aarch64','arm64'] else 'amd64' }}"
    docker_keyring: /etc/apt/keyrings/docker.gpg

  tasks:
    - name: Update & Upgrade APT Packages
      apt:
        update_cache: yes
        upgrade: dist


    - name: Check if required repo components are present
      ansible.builtin.shell: |
        set -o pipefail
        grep -qE '^[^#].*\bcontrib\b' /etc/apt/sources.list &&
        grep -qE '^[^#].*\bnon-free\b' /etc/apt/sources.list &&
        grep -qE '^[^#].*\bnon-free-firmware\b' /etc/apt/sources.list
      args:
        executable: /bin/bash
      register: repo_components
      changed_when: false
      failed_when: false

    - name: Add Required Repositories (quick halfâ€‘measure)
      ansible.builtin.command: sed -i 's/main/main contrib non-free non-free-firmware/' /etc/apt/sources.list
      when: repo_components.rc != 0

      
    - name: Update & Upgrade APT Packages Again
      apt:
        update_cache: yes
        upgrade: dist

    - name: Docker Installation & Other Prerequisites
      
      block:

        - name: Dependency Installation
          apt:
            name:
              - ca-certificates
              - curl
              - wget
              - gnupg
              - lsb-release
              - git
              - nvidia-driver
              - nvidia-container-toolkit
              - firmware-misc-nonfree
              - python3
              - python3-venv
              - python3-pip
              - python3-apt
            state: present
            update_cache: yes

        - name: Add Docker GPG Key
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/debian/gpg
            state: present

        - name: Add Docker Apt Repository
          ansible.builtin.apt_repository:
            repo: "deb [arch={{ docker_arch }}] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state: present

        - name: Update Apt cache again
          apt:
            update_cache: yes

        - name: Install Docker Engine
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            
        - name: Validate Nvidia driver with nvidia-smi
          command: nvidia-smi
          register: nvidia_smi_output
          changed_when: false
          failed_when: nvidia_smi_output.rc != 0

        - name: Show GPU info
          debug:
            msg: "{{ nvidia_smi_output.stdout }}"

        - name: Service Check
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Run Docker hello-world test container
          command: docker run --rm hello-world
          register: docker_test
          changed_when: false
          failed_when: docker_test.rc != 0

    - name: Show Docker test output
      debug:
        msg: "{{ docker_test.stdout }}"


    - name: Configure NVIDIA runtime for Docker
      ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
      register: nvidia_ctk
      changed_when: >
        (nvidia_ctk.rc == 0) and
        (
          ('updated' in (nvidia_ctk.stdout | default(''))) or
          ('updated' in (nvidia_ctk.stderr | default('')))
        )
      failed_when: nvidia_ctk.rc not in [0]
      notify: restart docker

    - name: restart docker
      ansible.builtin.systemd:
        name: docker
        state: restarted
        enabled: true
